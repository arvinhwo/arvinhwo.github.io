<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 8.1.1">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-A.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-A.png">
  <link rel="mask-icon" href="/images/favicon-A.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/7.0.0/css/all.min.css" integrity="sha256-VHqXKFhhMxcpubYf9xiWdCiojEbY9NexQ4jh8AxbvcM=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fancyapps-ui/5.0.31/fancybox/fancybox.css" integrity="sha256-gkQVf8UKZgQ0HyuxL/VnacadJ+D2Kox2TCEBuNQg5+w=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"arvinhwo.com","root":"/","images":"/images","scheme":"Gemini","darkmode":false,"version":"8.26.0","exturl":false,"sidebar":{"position":"left","width_expanded":320,"width_dual_column":240,"display":"post","padding":18,"offset":12},"hljswrap":true,"codeblock":{"theme":{"light":"default","dark":"stackoverflow-dark"},"prism":{"light":"prism","dark":"prism-dark"},"copy_button":{"enable":true,"style":"mac"},"fold":{"enable":true,"height":300},"language":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":true,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"duration":200,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"},"path":"/search.xml","localsearch":{"enable":true,"top_n_per_article":1,"unescape":false,"preload":false}}</script><script src="/js/config.js" defer></script>

    <meta name="description" content="System Verilog线程及线程间通信">
<meta property="og:type" content="article">
<meta property="og:title" content="SV线程">
<meta property="og:url" content="http://arvinhwo.com/SV%E7%BA%BF%E7%A8%8B/index.html">
<meta property="og:site_name" content="Arvin&#39;s TeckArk">
<meta property="og:description" content="System Verilog线程及线程间通信">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="http://arvinhwo.com/images/image-20250728173027785.png">
<meta property="og:image" content="http://arvinhwo.com/images/image-20250724095858230.png">
<meta property="og:image" content="http://arvinhwo.com/images/image-20250804105625565.png">
<meta property="article:published_time" content="2025-08-04T03:58:48.000Z">
<meta property="article:modified_time" content="2025-12-05T10:47:47.595Z">
<meta property="article:author" content="ArvinHwO">
<meta property="article:tag" content="sv">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://arvinhwo.com/images/image-20250728173027785.png">


<link rel="canonical" href="http://arvinhwo.com/SV%E7%BA%BF%E7%A8%8B/">


<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"en","comments":true,"permalink":"http://arvinhwo.com/SV%E7%BA%BF%E7%A8%8B/","path":"SV线程/","title":"SV线程"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>SV线程 | Arvin's TeckArk</title>
  








  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous" defer></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/next-theme-pjax/0.6.0/pjax.min.js" integrity="sha256-vxLn1tSKWD4dqbMRyv940UYw4sXgMtYcK6reefzZrao=" crossorigin="anonymous" defer></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/fancyapps-ui/5.0.31/fancybox/fancybox.umd.js" integrity="sha256-a+H7FYzJv6oU2hfsfDGM2Ohw/cR9v+hPfxHCLdmCrE8=" crossorigin="anonymous" defer></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pangu/7.2.0/pangu.umd.js" integrity="sha256-JnmRRnJK7DC6RQJbAJb6AXOM9OmWzS6z8eYultk/48Y=" crossorigin="anonymous" defer></script>
<script src="/js/utils.js" defer></script><script src="/js/motion.js" defer></script><script src="/js/sidebar.js" defer></script><script src="/js/next-boot.js" defer></script><script src="/js/pjax.js" defer></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-generator-searchdb/1.5.0/search.js" integrity="sha256-xFC6PJ82SL9b3WkGjFavNiA9gm5z6UBxWPiu4CYjptg=" crossorigin="anonymous" defer></script>
<script src="/js/third-party/search/local-search.js" defer></script>




  <script src="/js/third-party/fancybox.js" defer></script>



  




  

  <script class="next-config" data-name="enableMath" type="application/json">false</script><script class="next-config" data-name="mathjax" type="application/json">{"enable":true,"tags":"all","js":{"url":"https://cdnjs.cloudflare.com/ajax/libs/mathjax/3.2.2/es5/tex-mml-chtml.js","integrity":"sha256-MASABpB4tYktI2Oitl4t+78w/lyA+D7b/s9GEP0JOGI="}}</script>
<script src="/js/third-party/math/mathjax.js" defer></script>


  <script src="https://cdnjs.cloudflare.com/ajax/libs/quicklink/3.0.1/quicklink.umd.js" integrity="sha256-44BednzIpUeQJcY8qtLyarFu0UCCTbgmWOvaoehiFQQ=" crossorigin="anonymous" defer></script>
  <script class="next-config" data-name="quicklink" type="application/json">{"enable":true,"home":true,"archive":true,"delay":true,"timeout":3000,"priority":true,"url":"http://arvinhwo.com/SV%E7%BA%BF%E7%A8%8B/"}</script>
  <script src="/js/third-party/quicklink.js" defer></script>

  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
<!-- hexo injector head_end start -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css">

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/hexo-math@4.0.0/dist/style.css">
<!-- hexo injector head_end end --><style>.darkmode--activated{--body-bg-color:#282828;--content-bg-color:#333;--card-bg-color:#555;--text-color:#ccc;--blockquote-color:#bbb;--link-color:#ccc;--link-hover-color:#eee;--brand-color:#ddd;--brand-hover-color:#ddd;--table-row-odd-bg-color:#282828;--table-row-hover-bg-color:#363636;--menu-item-bg-color:#555;--btn-default-bg:#222;--btn-default-color:#ccc;--btn-default-border-color:#555;--btn-default-hover-bg:#666;--btn-default-hover-color:#ccc;--btn-default-hover-border-color:#666;--highlight-background:#282b2e;--highlight-foreground:#a9b7c6;--highlight-gutter-background:#34393d;--highlight-gutter-foreground:#9ca9b6}.darkmode--activated img{opacity:.75}.darkmode--activated img:hover{opacity:.9}.darkmode--activated code{color:#69dbdc;background:0 0}button.darkmode-toggle{z-index:9999}.darkmode-ignore,img{display:flex!important}.beian img{display:inline-block!important}</style></head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">Arvin's TeckArk</p>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="Search" role="button">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-book fa-fw"></i>Archives</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-sitemap fa-fw"></i>Categories</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>Search
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
      <div class="search-header">
        <span class="search-icon">
          <i class="fa fa-search"></i>
        </span>
        <div class="search-input-container">
          <input autocomplete="off" autocapitalize="off" maxlength="80"
                placeholder="Searching..." spellcheck="false"
                type="search" class="search-input">
        </div>
        <span class="popup-btn-close" role="button">
          <i class="fa fa-times-circle"></i>
        </span>
      </div>
      <div class="search-result-container">
        <div class="search-result-icon">
          <i class="fa fa-spinner fa-pulse fa-5x"></i>
        </div>
      </div>
    </div>
  </div>

</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#%E7%BA%BF%E7%A8%8B%E7%9A%84%E4%BD%BF%E7%94%A8"><span class="nav-number">1.</span> <span class="nav-text">线程的使用</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AE%9A%E4%B9%89%E7%89%B9%E6%80%A7"><span class="nav-number">1.1.</span> <span class="nav-text">定义特性</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%B9%B6%E8%A1%8C%E7%BA%BF%E7%A8%8B"><span class="nav-number">1.2.</span> <span class="nav-text">并行线程</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8A%A8%E6%80%81%E7%BA%BF%E7%A8%8B"><span class="nav-number">1.3.</span> <span class="nav-text">动态线程</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%B1%BB%E7%9A%84%E7%BA%BF%E7%A8%8B"><span class="nav-number">1.4.</span> <span class="nav-text">类的线程</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E7%BA%BF%E7%A8%8B%E7%9A%84%E5%81%9C%E6%AD%A2"><span class="nav-number">2.</span> <span class="nav-text">线程的停止</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%81%9C%E6%AD%A2%E5%86%85%E9%83%A8%E7%BA%BF%E7%A8%8B"><span class="nav-number">2.1.</span> <span class="nav-text">停止内部线程</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%81%9C%E6%AD%A2%E6%8C%87%E5%AE%9A%E7%BA%BF%E7%A8%8B"><span class="nav-number">2.2.</span> <span class="nav-text">停止指定线程</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%81%9C%E6%AD%A2%E4%BB%BB%E5%8A%A1%E7%BA%BF%E7%A8%8B"><span class="nav-number">2.3.</span> <span class="nav-text">停止任务线程</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E7%BA%BF%E7%A8%8B%E9%97%B4%E9%80%9A%E4%BF%A1"><span class="nav-number">3.</span> <span class="nav-text">线程间通信</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#IPC%E6%A6%82%E5%BF%B5"><span class="nav-number">3.1.</span> <span class="nav-text">IPC概念</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BA%8B%E4%BB%B6"><span class="nav-number">3.2.</span> <span class="nav-text">事件</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BA%8B%E4%BB%B6%E6%93%8D%E4%BD%9C"><span class="nav-number">3.2.1.</span> <span class="nav-text">事件操作</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BA%8B%E4%BB%B6%E7%AB%9E%E4%BA%89"><span class="nav-number">3.2.2.</span> <span class="nav-text">事件竞争</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BA%8B%E4%BB%B6%E4%BC%A0%E9%80%92"><span class="nav-number">3.2.3.</span> <span class="nav-text">事件传递</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%A4%9A%E4%BA%8B%E4%BB%B6%E7%AD%89%E5%BE%85"><span class="nav-number">3.2.4.</span> <span class="nav-text">多事件等待</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%97%97%E8%AF%AD"><span class="nav-number">3.3.</span> <span class="nav-text">旗语</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%9F%BA%E6%9C%AC%E7%89%B9%E6%80%A7"><span class="nav-number">3.3.1.</span> <span class="nav-text">基本特性</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%93%8D%E4%BD%9C%E6%96%B9%E6%B3%95"><span class="nav-number">3.3.2.</span> <span class="nav-text">操作方法</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BF%A1%E7%AE%B1"><span class="nav-number">3.4.</span> <span class="nav-text">信箱</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%9F%BA%E6%9C%AC%E7%89%B9%E6%80%A7-1"><span class="nav-number">3.4.1.</span> <span class="nav-text">基本特性</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%93%8D%E4%BD%9C%E6%96%B9%E6%B3%95-1"><span class="nav-number">3.4.2.</span> <span class="nav-text">操作方法</span></a></li></ol></li></ol></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="ArvinHwO"
      src="/images/A.png">
  <p class="site-author-name" itemprop="name">ArvinHwO</p>
  <div class="site-description" itemprop="description">Some Notes & Memos</div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">17</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">11</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">11</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author animated">
      <span class="links-of-author-item">
        <a href="mailto:root@arvinhwo.com" title="E-Mail → mailto:root@arvinhwo.com" rel="noopener me"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>
  <div class="cc-license animated" itemprop="license">
    <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" class="cc-opacity" rel="noopener" target="_blank"><img src="https://cdnjs.cloudflare.com/ajax/libs/creativecommons-vocabulary/2020.11.3/assets/license_badges/small/by_nc_sa.svg" alt="Creative Commons"></a>
  </div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="en">
    <link itemprop="mainEntityOfPage" href="http://arvinhwo.com/SV%E7%BA%BF%E7%A8%8B/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/A.png">
      <meta itemprop="name" content="ArvinHwO">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Arvin's TeckArk">
      <meta itemprop="description" content="Some Notes & Memos">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="SV线程 | Arvin's TeckArk">
      <meta itemprop="description" content="System Verilog线程及线程间通信">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          SV线程
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2025-08-04 11:58:48" itemprop="dateCreated datePublished" datetime="2025-08-04T11:58:48+08:00">2025-08-04</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2025-12-05 18:47:47" itemprop="dateModified" datetime="2025-12-05T18:47:47+08:00">2025-12-05</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/LNotes/" itemprop="url" rel="index"><span itemprop="name">LNotes</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/LNotes/SystemVerilog/" itemprop="url" rel="index"><span itemprop="name">SystemVerilog</span></a>
        </span>
    </span>

  
</div>

            <div class="post-description">System Verilog线程及线程间通信</div>
        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody"><h1 id="线程的使用"><a href="#线程的使用" class="headerlink" title="线程的使用"></a>线程的使用</h1><h2 id="定义特性"><a href="#定义特性" class="headerlink" title="定义特性"></a>定义特性</h2><ul>
<li>线程是独立运行的程序单元，线程（thread）与进程（process）经常互换使用</li>
<li>每个<code>initial</code>或<code>always</code>过程块均派生一个独立线程，仿真0时刻开始执行<ul>
<li><code>initial</code>及显式线程可主动结束</li>
<li><code>always</code>线程持续监控信号</li>
</ul>
</li>
<li>父线程可衍生多个子线程，如<code>fork</code>内嵌多个子块<ul>
<li><code>fork-join</code>结构可显式创建并行子线程，但必须等所有子线程执行完后才可进行后续的处理</li>
<li><code>begin-end</code>结构以顺序结构执行，可以用于过程块<code>initial</code>中，或用作<code>fork-join</code>中的一个顺序子线程</li>
</ul>
</li>
</ul>
<h2 id="并行线程"><a href="#并行线程" class="headerlink" title="并行线程"></a>并行线程</h2><p><img src="/images/image-20250728173027785.png" alt="image-20250728173027785"></p>
<ul>
<li><code>fork-join</code>：所有子线程结束才继续后续代码<ul>
<li>标准Verilog语句，适用于需要等待所有并发任务完成的场景</li>
</ul>
</li>
<li><code>fork-join_any</code>：任一子线程结束即可继续后续代码<ul>
<li>SV引入的创建线程新方法，适用于等待首个任务响应，如超时控制等</li>
</ul>
</li>
<li><code>fork-join_none</code>：立即继续主线程，子线程后台并行<ul>
<li>SV引入的创建线程新方法，适用于启动异步任务，如监测信号等</li>
</ul>
</li>
<li><code>wait fork;</code>语句放在<code>fork-join</code>及其变体后，用于等待所有子线程结束</li>
</ul>
<h2 id="动态线程"><a href="#动态线程" class="headerlink" title="动态线程"></a>动态线程</h2><ul>
<li>动态线程是在<strong>运行时</strong>通过显示语法（<code>fork-join</code>及其变体）创建的子线程，而<strong>非静态编译时</strong>定义的线程（<code>always</code>、<code>initial</code>、<code>fork-join</code>）<ul>
<li>允许类、任务或函数内部生成子线程，实现子线程与父线程并发运行</li>
<li>若线程使用<code>automatic</code>存储类，变量在每次调用时独立分配内存，避免多线竞争</li>
<li>子线程在启动后独立运行，可自动结束或通过同步机制（事件<code>event</code>、旗语<code>semaphore</code>、信箱<code>mailbox</code>）控制终止</li>
<li>常用于测试平台的事务处理、验证场景的并行激励生成等</li>
</ul>
</li>
<li>下例中，测试平台产生随机事务并发送到被测设计中，在等待被测设计回复的过程中，同时也不停止随机数据的产生</li>
</ul>
<figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">program</span> <span class="keyword">automatic</span> test (bus_ifc<span class="variable">.TB</span> bus);</span><br><span class="line">    <span class="comment">//省略接口代码</span></span><br><span class="line">    <span class="comment">//当check_trans被调用时，将产生一个线程用来检测总线来获取匹配的事务数据</span></span><br><span class="line">    <span class="keyword">task</span> check_trans(<span class="keyword">input</span> Transaction tr);</span><br><span class="line">        <span class="keyword">fork</span></span><br><span class="line">            <span class="keyword">begin</span></span><br><span class="line">                <span class="keyword">wait</span> (bus<span class="variable">.cb</span><span class="variable">.data</span> == tr<span class="variable">.data</span>);</span><br><span class="line">                <span class="built_in">$display</span>(<span class="string">&quot;@%0t: data match %d&quot;</span>, <span class="built_in">$time</span>, tr<span class="variable">.data</span>);</span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line">        <span class="keyword">join_none</span>             <span class="comment">//不阻塞的并发线程</span></span><br><span class="line">    <span class="keyword">endtask</span></span><br><span class="line">    </span><br><span class="line">    Transaction tr;           <span class="comment">// 声明事务类型</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">initial</span> <span class="keyword">begin</span></span><br><span class="line">        <span class="keyword">repeat</span> (<span class="number">10</span>) <span class="keyword">begin</span></span><br><span class="line">            tr = <span class="keyword">new</span>();       <span class="comment">//创建一个随机事务</span></span><br><span class="line">            `SV_RAND_CHECK(tr<span class="variable">.randomize</span>());</span><br><span class="line">            transmit(tr);     <span class="comment">//把事务发送到被测设计中</span></span><br><span class="line">            check_trans(tr);  <span class="comment">//并行等待被测设计回复</span></span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">        #<span class="number">100</span>;</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">endprogram</span></span><br></pre></td></tr></table></figure>

<h2 id="类的线程"><a href="#类的线程" class="headerlink" title="类的线程"></a>类的线程</h2><ul>
<li>在类中创建线程，要求线程控制权与任务逻辑分离<ul>
<li>类内线程不应该在父类中启动，而是在任务<code>run</code>里产生，受到到子类控制</li>
<li>构造函数<code>new()</code>只用来对数值进行初始化，不启动任何线程</li>
</ul>
</li>
</ul>
<figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> Gen_drive;             <span class="comment">//带任务run的发生器/驱动器</span></span><br><span class="line">    <span class="keyword">task</span> run (<span class="keyword">input</span> <span class="keyword">int</span> n);  <span class="comment">//N个数据包的事务处理器</span></span><br><span class="line">        Packet p;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">fork</span></span><br><span class="line">            <span class="keyword">repeat</span> (n) <span class="keyword">begin</span> <span class="comment">//顺序重复n次代码块</span></span><br><span class="line">                `SV_RAND_CHECK(p<span class="variable">.randomize</span>());</span><br><span class="line">                transmit(p);</span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line">        <span class="keyword">join_none</span>            <span class="comment">//使用fork-join_none避免repeat(n)阻塞run()</span></span><br><span class="line">    <span class="keyword">endtask</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">task</span> transmit(<span class="keyword">input</span> Packet p);</span><br><span class="line">        ...</span><br><span class="line">    <span class="keyword">endtask</span></span><br><span class="line"><span class="keyword">endclass</span></span><br><span class="line"></span><br><span class="line">Gen_drive gen;</span><br><span class="line"></span><br><span class="line"><span class="keyword">initial</span> <span class="keyword">begin</span></span><br><span class="line">    gen = <span class="keyword">new</span>();               <span class="comment">//调用构造函数，完成初始化</span></span><br><span class="line">    gen<span class="variable">.run</span>(<span class="number">10</span>);               <span class="comment">//启动类内线程</span></span><br><span class="line">    ...                        <span class="comment">//启动检验、监测和其他线程</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<h1 id="线程的停止"><a href="#线程的停止" class="headerlink" title="线程的停止"></a>线程的停止</h1><ul>
<li>在SV中，停止线程主要通过<code>disable</code>语句实现，避免使用暴力终止，如使用过时的<code>stop()</code></li>
</ul>
<h2 id="停止内部线程"><a href="#停止内部线程" class="headerlink" title="停止内部线程"></a>停止内部线程</h2><ul>
<li>在<code>fork-join</code>块内使用<code>disable fork;</code>停止所有子进程<ul>
<li>使用<code>fork-join</code>把目标代码包围起来以限制<code>disable fork</code>语句的作用范围</li>
</ul>
</li>
</ul>
<figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">initial</span> <span class="keyword">begin</span></span><br><span class="line">    check_trans(tr0);             <span class="comment">// 线程0，使用了动态线程中定义的一个任务</span></span><br><span class="line">    <span class="keyword">fork</span>                          <span class="comment">// 线程1</span></span><br><span class="line">        <span class="keyword">begin</span></span><br><span class="line">            check_trans(tr1);     <span class="comment">// 线程1.1，父线程为线程1</span></span><br><span class="line">            check_trans(tr2);     <span class="comment">// 线程1.2</span></span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">        #<span class="number">123</span> <span class="keyword">disable</span> <span class="keyword">fork</span>;        <span class="comment">// 除线程0外其余线程全部停止</span></span><br><span class="line">    <span class="keyword">join</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<h2 id="停止指定线程"><a href="#停止指定线程" class="headerlink" title="停止指定线程"></a>停止指定线程</h2><ul>
<li>为线程指定标签，使用带标签的<code>disable</code>语句</li>
</ul>
<figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">initial</span> <span class="keyword">begin</span></span><br><span class="line">    check_trans(tr0);             <span class="comment">// 线程0</span></span><br><span class="line">    <span class="keyword">fork</span>                          <span class="comment">// 线程1</span></span><br><span class="line">        <span class="keyword">begin</span> : thread1</span><br><span class="line">            check_trans(tr1);     <span class="comment">// 线程1.1</span></span><br><span class="line">            check_trans(tr2);     <span class="comment">// 线程1.2</span></span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">        #<span class="number">123</span> <span class="keyword">disable</span> thread1;     <span class="comment">// 保留线程0</span></span><br><span class="line">    <span class="keyword">join</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<ul>
<li>停止指定<code>fork-join</code>块中所有线程<ul>
<li>在下例中，如果正确的总线来得足够早，则等<code>wait</code>结构先完成，<code>fork-join_any</code>得以执行，之后的<code>disable</code>结束剩余的线程</li>
<li>如果正确的总线在<code>TIME_OUT</code>时延完成时没有到来，则会打印错误警告的信息，<code>fork-join_any</code>被执行，之后<code>disalbe</code>结束<code>wait</code>线程</li>
</ul>
</li>
</ul>
<figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">parameter</span> TIME_OUT = <span class="number">1000</span>ns;</span><br><span class="line"></span><br><span class="line"><span class="keyword">task</span> check_trans(<span class="keyword">input</span> Transaction tr);</span><br><span class="line">    <span class="keyword">fork</span></span><br><span class="line">        <span class="keyword">begin</span></span><br><span class="line">            <span class="keyword">fork</span> : timeout_block</span><br><span class="line">                <span class="keyword">begin</span>                             <span class="comment">// thread1 in timeout_block</span></span><br><span class="line">                    <span class="keyword">wait</span> (bus<span class="variable">.cb</span><span class="variable">.data</span> == tr<span class="variable">.data</span>);</span><br><span class="line">                    <span class="built_in">$display</span>(<span class="string">&quot;@%0t: data match %d&quot;</span>, <span class="built_in">$time</span>, tr<span class="variable">.data</span>);</span><br><span class="line">                <span class="keyword">end</span></span><br><span class="line">                #TIME_OUT <span class="built_in">$display</span>(<span class="string">&quot;@%0t: Error: timeout&quot;</span>, <span class="built_in">$time</span>); <span class="comment">// thread2</span></span><br><span class="line">            <span class="keyword">join_any</span></span><br><span class="line">            <span class="keyword">disable</span> timeout_block;</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">join_none</span>   <span class="comment">// 产生非阻塞的线程</span></span><br><span class="line"><span class="keyword">endtask</span></span><br></pre></td></tr></table></figure>

<h2 id="停止任务线程"><a href="#停止任务线程" class="headerlink" title="停止任务线程"></a>停止任务线程</h2><ul>
<li>当从任务块内部停止该块时，将会停止所有由该任务启动的线程<ul>
<li>使用<code>disable</code>标签语句将停止所有所有使用这段代码的线程，不仅仅是当前线程</li>
</ul>
</li>
<li>在下例中，任务<code>wait_for_time_out</code>被调用三次，从而产生了三个线程<ul>
<li>线程0在<code>#2ns</code>延时后禁止了该任务，三个线程都启动了，但最终都停止了</li>
<li>如果这个任务位于多次实例化的驱动器类中，则其中的<code>disable</code>标签语句将停止所有块</li>
</ul>
</li>
</ul>
<figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">task</span> wait_for_time_out (<span class="keyword">input</span> <span class="keyword">int</span> id);</span><br><span class="line">    <span class="keyword">if</span> (id == <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">fork</span></span><br><span class="line">            <span class="keyword">begin</span></span><br><span class="line">                #<span class="number">2</span>ns;</span><br><span class="line">                <span class="built_in">$display</span>(<span class="string">&quot;@%0t: disable wait_for_time_out&quot;</span>, <span class="built_in">$time</span>);</span><br><span class="line">                disabel wait_for_time_out;</span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line">        <span class="keyword">join_none</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">fork</span> : just_a_little</span><br><span class="line">        <span class="keyword">begin</span></span><br><span class="line">            <span class="built_in">$display</span>(<span class="string">&quot;@%0t: %m: %0d entering thread&quot;</span>, <span class="built_in">$time</span>, id);</span><br><span class="line">            #TIME_OUT;</span><br><span class="line">            <span class="built_in">$display</span>(<span class="string">&quot;@%0t: %m: %0d done&quot;</span>, <span class="built_in">$time</span>, id); <span class="comment">// %m表示输出调用此语句的模块的层次路径</span></span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">join_none</span></span><br><span class="line"><span class="keyword">endtask</span></span><br></pre></td></tr></table></figure>

<h1 id="线程间通信"><a href="#线程间通信" class="headerlink" title="线程间通信"></a>线程间通信</h1><h2 id="IPC概念"><a href="#IPC概念" class="headerlink" title="IPC概念"></a>IPC概念</h2><ul>
<li>每个线程都会和相邻的线程通信<ul>
<li>环境类需要知道发生器什么时候完成任务，以便及时终止测试平台还在运行的线程</li>
<li>如下图测试平台环境中的发生器把激励传递给代理</li>
</ul>
</li>
</ul>
<p><img src="/images/image-20250724095858230.png" alt="image-20250724095858230"></p>
<ul>
<li>所有数据交换和控制的同步被称为线程间的通信（Inter-Process Communication, IPC），本章介绍以下三种<ul>
<li>事件：用于控制多线程间的同步</li>
<li>旗语：用于控制多线程对共享资源的访问</li>
<li>信箱：用于控制多线程间的信息传递或者线程间通信</li>
</ul>
</li>
</ul>
<h2 id="事件"><a href="#事件" class="headerlink" title="事件"></a>事件</h2><h3 id="事件操作"><a href="#事件操作" class="headerlink" title="事件操作"></a>事件操作</h3><ul>
<li>触发事件（Trigger）：通过<code>-&gt;</code>操作符通知事件发生</li>
<li>等待事件（Wait）：通过阻塞线程知道事件被触发<ul>
<li>边沿敏感型：<code>@</code>，检测事件的上升沿，从无触发到触发</li>
<li>电平敏感型：SV引入<code>wait(event_example.triggered)</code>，检测事件是否已经被触发过</li>
</ul>
</li>
</ul>
<h3 id="事件竞争"><a href="#事件竞争" class="headerlink" title="事件竞争"></a>事件竞争</h3><ul>
<li>在同一仿真时间步内，多个线程因时间等待与触发顺序不确定而发生的竞争状态，导致在不同的仿真器中运行的结果可能不同<ul>
<li>下例中，先执行B？A永远阻塞</li>
<li>先执行A？A需要捕获事件才继续</li>
<li>同时执行？取决于仿真器</li>
</ul>
</li>
</ul>
<figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">event</span> my_event;</span><br><span class="line"><span class="keyword">initial</span> <span class="keyword">begin</span>         <span class="comment">// 进程A</span></span><br><span class="line">  @my_event;          <span class="comment">// 事件等待</span></span><br><span class="line">  <span class="built_in">$display</span>(<span class="string">&quot;Process A activated&quot;</span>);</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">initial</span> <span class="keyword">begin</span>          <span class="comment">// 进程B</span></span><br><span class="line">  -&gt; my_event;         <span class="comment">// 事件触发</span></span><br><span class="line">  <span class="built_in">$display</span>(<span class="string">&quot;Process B triggered&quot;</span>);</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<ul>
<li>若在循环中使用<code>wait(handshake.triggered)</code>，需确保在<strong>下次等待所处的仿真时间步不能与本次等待的相同</strong>，否则代码进入一个零时延循环<ul>
<li>若时间步不变，<code>.triggered</code>不会重置，<code>wait</code>再次立即通过，形成无线循环</li>
<li>可以使用边沿敏感型等待事件，避免<code>.triggered</code>不重置的问题</li>
<li>或使用<code>#0</code>使进程挂起指导指定延时结束，当恢复执行，时间已推进</li>
</ul>
</li>
</ul>
<figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">forever</span> <span class="keyword">begin</span> <span class="comment">// 这是一个零时延循环，造成仿真的不确定</span></span><br><span class="line">    <span class="keyword">wait</span>(handshake<span class="variable">.triggered</span>);</span><br><span class="line">    <span class="built_in">$display</span>(<span class="string">&quot;Received next event&quot;</span>);</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">forever</span> <span class="keyword">begin</span> <span class="comment">// 使用边沿敏感或时延+电平敏感避免零时延循环</span></span><br><span class="line">    @handshake;</span><br><span class="line">    <span class="comment">// #0 wait(handshake.triggered);</span></span><br><span class="line">    <span class="built_in">$display</span>(<span class="string">&quot;Received next event&quot;</span>);</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<h3 id="事件传递"><a href="#事件传递" class="headerlink" title="事件传递"></a>事件传递</h3><ul>
<li>在SV中，事件作为同步对象的句柄，可以传递给子程序<ul>
<li>允许在对象间共享事件，不用把事件定义成全局的，最常见的方式是把事件传递到一个对象的构造器中</li>
<li>下例中，一个事件被事务处理器用来作为其执行完毕的标志信号</li>
</ul>
</li>
</ul>
<figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">program</span> <span class="keyword">automatic</span> test;</span><br><span class="line">    <span class="keyword">class</span> generator;</span><br><span class="line">        <span class="keyword">event</span> done;</span><br><span class="line">        <span class="keyword">function</span> <span class="keyword">new</span> (<span class="keyword">input</span> <span class="keyword">event</span> done);   <span class="comment">// 从测试平台传来事件</span></span><br><span class="line">            <span class="keyword">this</span><span class="variable">.done</span> = done;              <span class="comment">// 同步句柄：测试平台中的gen_done与类中的done同步</span></span><br><span class="line">        <span class="keyword">endfunction</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">task</span> run();</span><br><span class="line">            <span class="keyword">fork</span></span><br><span class="line">                <span class="keyword">begin</span></span><br><span class="line">                    ...                     <span class="comment">// 创建事务</span></span><br><span class="line">                    -&gt; done;                <span class="comment">// 告知测试程序任务已完成</span></span><br><span class="line">                <span class="keyword">end</span></span><br><span class="line">            <span class="keyword">join_none</span></span><br><span class="line">        <span class="keyword">endtask</span></span><br><span class="line">    <span class="keyword">endclass</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">event</span> gen_done;</span><br><span class="line">    generator gen;</span><br><span class="line">    <span class="keyword">initial</span> <span class="keyword">begin</span></span><br><span class="line">        gen = <span class="keyword">new</span>(gen_done);                 <span class="comment">// 测试程序实例化</span></span><br><span class="line">        gen<span class="variable">.run</span>();                           <span class="comment">// 运行事务处理器</span></span><br><span class="line">        <span class="keyword">wait</span>(gen_done<span class="variable">.triggered</span>);            <span class="comment">// 等待任务结束</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">endprogram</span></span><br></pre></td></tr></table></figure>

<h3 id="多事件等待"><a href="#多事件等待" class="headerlink" title="多事件等待"></a>多事件等待</h3><ul>
<li>上例中只有单个发生器释放单个时间，如果测试环境类有N个发生器，必须等待多个子线程完成</li>
<li>传递事件句柄等待多事件<ul>
<li>使用<code>wait fork</code>来等待所有子线程约束</li>
<li>也可以使用<code>wait_order(event1, event2)</code>来等待指定顺序的事件</li>
</ul>
</li>
</ul>
<figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">event</span> done[N_GENERATORS];         <span class="comment">// 定义N个发生器的阻塞事件</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">initial</span> <span class="keyword">begin</span></span><br><span class="line">    <span class="keyword">foreach</span> (gen[i]) <span class="keyword">begin</span></span><br><span class="line">        gen[i] = <span class="keyword">new</span>(done[i]);    <span class="comment">// 创建N个发生器</span></span><br><span class="line">        gen[i]<span class="variable">.run</span>();             <span class="comment">// 发生器开始运行</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">foreach</span> (gen[i])</span><br><span class="line">        <span class="keyword">fork</span></span><br><span class="line">            <span class="keyword">automatic</span> <span class="keyword">int</span> k = i;</span><br><span class="line">            <span class="keyword">wait</span> (done[k]<span class="variable">.trriggered</span>);</span><br><span class="line">        <span class="keyword">join_none</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">wait</span> <span class="keyword">fork</span>;                     <span class="comment">// 等待所有触发事件完成</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<ul>
<li>通过对触发事件进行计数来等待多个线程</li>
</ul>
<figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">event</span> done[N_GENERATORS];</span><br><span class="line"><span class="keyword">int</span> done_count;</span><br><span class="line"></span><br><span class="line"><span class="keyword">initial</span> <span class="keyword">begin</span></span><br><span class="line">    <span class="keyword">foreach</span> (gen[i]) <span class="keyword">begin</span></span><br><span class="line">        gen[i] = <span class="keyword">new</span>(done[i]);       <span class="comment">// 创建N个发生器</span></span><br><span class="line">        gen[i]<span class="variable">.run</span>();                <span class="comment">// 发生器开始运行</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">foreach</span> (gen[i])</span><br><span class="line">        <span class="keyword">fork</span></span><br><span class="line">            <span class="keyword">automatic</span> <span class="keyword">int</span> k = i;</span><br><span class="line">            done_count++;</span><br><span class="line">        <span class="keyword">join_none</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">wait</span> (done_count == N_GENERATORS); <span class="comment">// 等待触发</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<ul>
<li>使用线程计数来等待多个线程<ul>
<li>使用类作用域分辨操作符<code>::</code>：用于明确指定访问某个类作用域内的成员</li>
</ul>
</li>
</ul>
<figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> Generator;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">int</span> thread_count = <span class="number">0</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">task</span> run();</span><br><span class="line">        thread_count++;         <span class="comment">// 启动另一个线程</span></span><br><span class="line">        <span class="keyword">fork</span></span><br><span class="line">            <span class="keyword">begin</span></span><br><span class="line">                ...             <span class="comment">// 实际事务代码</span></span><br><span class="line">                thread_count--;   <span class="comment">// 事务完成时，线程数目减一</span></span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line">        <span class="keyword">join_none</span></span><br><span class="line">    <span class="keyword">endtask</span></span><br><span class="line"><span class="keyword">endclass</span></span><br><span class="line"></span><br><span class="line">Generator gen[N_GENERATORS];</span><br><span class="line"></span><br><span class="line"><span class="keyword">initial</span> <span class="keyword">begin</span></span><br><span class="line">    <span class="keyword">foreach</span> (gen[i])</span><br><span class="line">        gen[i] = <span class="keyword">new</span>();</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">foreach</span> (gen[i])</span><br><span class="line">        gen[i]<span class="variable">.run</span>();</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">wait</span> (Generator::thead_count == <span class="number">0</span>);</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<h2 id="旗语"><a href="#旗语" class="headerlink" title="旗语"></a>旗语</h2><h3 id="基本特性"><a href="#基本特性" class="headerlink" title="基本特性"></a>基本特性</h3><ul>
<li>作用：一种同步机制，用于控制多线程对共享资源的访问</li>
<li>类型：旗语<code>semaphore</code>是SV内置类，维护一个可用资源数量计数器</li>
</ul>
<h3 id="操作方法"><a href="#操作方法" class="headerlink" title="操作方法"></a>操作方法</h3><ul>
<li>创建旗语：<code>semaphore sem = new(1);</code><ul>
<li>包含两步操作：声明旗语变量<code>semaphore sem;</code>，创建旗语并初始化计数器为1<code>sem = new(1);</code></li>
</ul>
</li>
<li>获取钥匙：<code>sem.get(1);</code><ul>
<li>进程访问共享资源前，通过<code>get()</code>获取钥匙，减少计数器，若钥匙不足则阻塞等待</li>
<li>多个阻塞线程以先进先出（FIFO）的方式排队</li>
</ul>
</li>
<li>归还钥匙：<code>sem.put(1);</code><ul>
<li>访问完成后，通过<code>put()</code>归还钥匙，增加计数器，允许其他进程获取</li>
<li>注意归还的钥匙可以比取出来的多</li>
</ul>
</li>
<li>尝试获取：<code>sem.try_get(1);</code><ul>
<li>尝试获取一把钥匙，成功返回<code>1</code>，失败返回<code>0</code>，非阻塞</li>
</ul>
</li>
</ul>
<figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">semaphore sem = <span class="keyword">new</span>(<span class="number">1</span>); <span class="comment">// 创建含1把钥匙的信号量</span></span><br><span class="line">process_A: <span class="keyword">begin</span></span><br><span class="line">    sem<span class="variable">.get</span>(<span class="number">1</span>);         <span class="comment">// 获取钥匙</span></span><br><span class="line">    shared_var = ...;   <span class="comment">// 安全访问共享变量</span></span><br><span class="line">    sem<span class="variable">.put</span>(<span class="number">1</span>);         <span class="comment">// 归还钥匙</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line">process_B: <span class="keyword">begin</span></span><br><span class="line">    sem<span class="variable">.get</span>(<span class="number">1</span>);         <span class="comment">// 若钥匙被占用，则阻塞等待</span></span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<h2 id="信箱"><a href="#信箱" class="headerlink" title="信箱"></a>信箱</h2><p><img src="/images/image-20250804105625565.png" alt="image-20250804105625565"></p>
<h3 id="基本特性-1"><a href="#基本特性-1" class="headerlink" title="基本特性"></a>基本特性</h3><ul>
<li>作用：用于并发线程间的数据交换</li>
<li>类型：信箱<code>mailbox</code>是SV内置类，维护一个有界或无界的消息队列<ul>
<li>有界：固定容量，满时阻塞；无界，理论上无限容量</li>
</ul>
</li>
</ul>
<h3 id="操作方法-1"><a href="#操作方法-1" class="headerlink" title="操作方法"></a>操作方法</h3><ul>
<li>创建信箱<ul>
<li>声明参数化信箱，可以强制邮箱使用一种数据类型</li>
</ul>
</li>
</ul>
<figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">mailbox mbx;   <span class="comment">// 声明信箱变量</span></span><br><span class="line">mbx = <span class="keyword">new</span>();   <span class="comment">// 创建无界信箱</span></span><br><span class="line">mbc = <span class="keyword">new</span>(<span class="number">10</span>); <span class="comment">// 创建有界信箱，容量为10</span></span><br><span class="line"></span><br><span class="line">mailbox <span class="variable">#(int) int_mbx = new()</span>;    <span class="comment">// 只能存放int类型的信箱</span></span><br><span class="line">mailbox <span class="variable">#(string) str_mbx = new()</span>; <span class="comment">// 只能存放string类型的信箱</span></span><br><span class="line">int_mbx<span class="variable">.put</span>(<span class="number">42</span>);</span><br><span class="line"><span class="comment">// int_mbx.put(&quot;hello&quot;);           // 编译错误，类型不匹配</span></span><br></pre></td></tr></table></figure>

<ul>
<li>放入数据：<code>mbx.put(data)</code><ul>
<li>生产方将<code>data</code>放入信箱，若信箱满则阻塞</li>
<li>数据可以是整数、任意宽度<code>logic</code>或句柄</li>
</ul>
</li>
<li>获取数据：<code>mbx.get(data)</code><ul>
<li>消费方从信箱获取数据到<code>data</code>变量，同时在信箱中移除，若信箱空则阻塞</li>
</ul>
</li>
<li>尝试放入：<code>mbx.try_put(data)</code><ul>
<li>尝试放入数据，成功返回1，信箱满返回0，非阻塞</li>
</ul>
</li>
<li>尝试获取：<code>mbx.try_get(data)</code><ul>
<li>尝试获取数据，成功返回1，信箱空返回0，非阻塞</li>
</ul>
</li>
<li>探视数据：<code>mbx.peek(data)</code><ul>
<li>探视信箱里的数据但不将其移除</li>
<li>允许接收方检查数据内容后再决定是否处理</li>
<li>允许同一数据可以被多个线程查看</li>
</ul>
</li>
<li>获取数量：<code>mbx.num()</code><ul>
<li>返回信箱中当前消息的数量</li>
</ul>
</li>
</ul>
<figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">mailbox <span class="variable">#(int) mbx = new(5)</span>;    <span class="comment">// 容量为5的有界参数化信箱，指定存储整型</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 生产者进程</span></span><br><span class="line"><span class="keyword">initial</span> <span class="keyword">begin</span></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;<span class="number">10</span>; i++) <span class="keyword">begin</span></span><br><span class="line">    mbx<span class="variable">.put</span>(i);          <span class="comment">// 放入数据</span></span><br><span class="line">    <span class="built_in">$display</span>(<span class="string">&quot;Produced: %0d&quot;</span>, i);</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 消费者进程</span></span><br><span class="line"><span class="keyword">initial</span> <span class="keyword">begin</span></span><br><span class="line">  <span class="keyword">int</span> received;</span><br><span class="line">  <span class="keyword">forever</span> <span class="keyword">begin</span></span><br><span class="line">    mbx<span class="variable">.get</span>(received);   <span class="comment">// 获取数据</span></span><br><span class="line">    <span class="built_in">$display</span>(<span class="string">&quot;Consumed: %0d&quot;</span>, received);</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>


    </div>

    
    
    

    <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/sv/" rel="tag"><i class="fa fa-tag"></i> sv</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/Next%E9%85%8D%E7%BD%AE/" rel="prev" title="Next配置">
                  <i class="fa fa-angle-left"></i> Next配置
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/Eclipse%E6%8C%87%E5%8D%97/" rel="next" title="Eclipse指南">
                  Eclipse指南 <i class="fa fa-angle-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 
    <span itemprop="copyrightYear">2025</span>
    <span class="with-love">
      <i class="fa fa-blog"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">ArvinHwO</span>
  </div>

    </div>
  </footer>

  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>
  <div class="sidebar-dimmer"></div>
  <div class="back-to-top" role="button" aria-label="Back to top">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>
<script src="https://cdn.jsdelivr.net/npm/darkmode-js@1.5.7/lib/darkmode-js.min.js"></script>

<script>
var options = {
  bottom: '24px',
  right: '20px',
  left: 'unset',
  time: '0.5s',
  mixColor: 'transparent',
  backgroundColor: 'transparent',
  buttonColorDark: '#100f2c',
  buttonColorLight: '#fff',
  saveInCookies: true,
  label: '🌓',
  autoMatchOsTheme: true
}
const darkmode = new Darkmode(options);
window.darkmode = darkmode;
darkmode.showWidget();
</script>

</body>
</html>
